---
- name: Create vault group
  ansible.builtin.group:
    name: "{{ vault_group }}"
    state: present

- name: Create vault user
  ansible.builtin.user:
    name: "{{ vault_user }}"
    group: "{{ vault_group }}"
    system: "yes"
    shell: "/usr/sbin/nologin"

- name: Check Vault installation
  ansible.builtin.shell: command -v vault  # noqa command-instead-of-shell  # command is a shell builtin
  environment:
    PATH: "{{ vault_bin_path }}:{{ ansible_facts['env']['PATH'] }}"
  register: vault_installation
  changed_when: false
  failed_when: false
  check_mode: false

- name: Get installed Vault version
  ansible.builtin.shell: |
    set -o pipefail
    {{ vault_bin_path }}/vault -version | cut -d' ' -f2 | tr -d 'v'
  args:
    executable: /bin/bash
  when: vault_installation.rc == 0
  changed_when: false
  check_mode: false
  register: installed_vault_version

- name: Compute if installation is required
  ansible.builtin.set_fact:
    installation_required: "{{ vault_installation.rc != 0 or installed_vault_version.stdout != vault_version }}"

- name: Install vault binary
  ansible.builtin.include_tasks: install_vault.yml
  when: installation_required

- name: Create directories
  become: true
  ansible.builtin.file:
    dest: "{{ item }}"
    state: directory
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: "0750"
  with_items:
    - "{{ vault_config_path }}"
    - "{{ vault_tls_path }}"
    - "{{ vault_plugin_path }}"
    - "{{ vault_policy_path }}"
    - "{{ vault_data_path }}"
    - "{{ vault_log_path }}"

- name: Vault main configuration
  become: true
  ansible.builtin.template:
    src: "vault_main_configuration.hcl.j2"
    dest: "{{ vault_main_config }}"
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: "0400"
    backup: "true"
  notify:
    - Restart vault
    - Reload vault systemd

- name: Copy TLS private key file
  ansible.builtin.copy:
    dest: "{{ vault_tls_path }}/vault.key"
    content: "{{ vault_key }}"
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: "0644"
  become: true
  when: vault_enable_tls
  notify: Restart vault

- name: Copy cert file
  ansible.builtin.copy:
    dest: "{{ vault_tls_path }}/vault.crt"
    content: "{{ vault_cert }}"
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: "0644"
  become: true
  when: vault_enable_tls
  notify: Restart vault

- name: Copy CA cert file
  ansible.builtin.copy:
    dest: "{{ vault_tls_path }}/vault-ca.crt"
    content: "{{ vault_ca }}"
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: "0644"
  become: true
  when: vault_enable_tls and custom_ca
  notify: Restart vault

- name: Create the Vault server systemd config
  ansible.builtin.template:
    src: vault.service.j2
    dest: "/etc/systemd/system/vault.service"
    owner: "root"
    group: "root"
    mode: "0644"
  notify:
    - Reload vault systemd
    - Restart vault

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Ensure vault is started at boot
  ansible.builtin.service:
    name: vault
    enabled: true

- name: Initialize Vault
  ansible.builtin.include_tasks: initialize_vault.yml
  when: vault_init

- name: Useal Vault
  ansible.builtin.include_tasks: unseal_vault.yml
  when: vault_unseal

- name: Install unseal service
  ansible.builtin.include_tasks: install_unseal_service.yml
  when: vault_unseal_service

- name: Run configuration tasks
  ansible.builtin.include_tasks:
    file: configure_vault.yml
  when:
    - vault_kv_secrets is defined
